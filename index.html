<!DOCTYPE html>
<html>
<head>
<title>ESP32 Live Temperature Graph</title>
<script src="https://cdn.jsdelivr.net/npm/dygraphs@2.1.0/dist/dygraph.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dygraphs@2.1.0/dist/dygraph.css" />
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background-color: #e0e0e0;
    margin: 0;
    padding: 5px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }
  h1 {
    color: #000066;
    font-size: 2.5em;
    margin-bottom: 5px;
  }
  #totalTimePassed {
    color: #555555;
    margin-top: 0;
    margin-bottom: 10px;
    font-size: 1.2em;
  }
  #liveTempDisplay {
    color: #333;
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 1.1em;
  }
  #liveTempDisplay sub {
    vertical-align: sub;
    font-size: smaller;
  }

  /* Wrapper for graph and legend */
  #mainContentWrapper {
    display: flex;
    flex-direction: row; 
    align-items: flex-start; 
    justify-content: center;
    width: 95%;
    max-width: 1300px; 
    /* The 'gap' property is removed to allow for custom positioning */
  }

  #chartContainer {
    flex-grow: 1; 
    max-width: 900px;
    background-color: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border: 2px solid black;
    box-sizing: border-box;
  }

  #graphdiv {
    width: 100%;
    height: 500px;
  }

  /* CSS for the custom legend container */
  #legendContainer {
    width: auto; /* Auto-size width to content */
    flex-shrink: 0; 
    background-color: rgba(255, 255, 255, 0.85); /* Semi-transparent background */
    padding: 5px 15px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 1px solid #ababab;
    box-sizing: border-box;
    /* Positioning changes */
    margin-left: -325px; /* Move 50px to the left */
    position: relative;
    top: 2px;
    z-index: 10; /* Ensure it's on top of the graph */
  }
  #legendContainer h3 {
      display: none; /* Hide the "Legend" title */
  }
  #customLegend {
      display: flex; /* Arrange legend items horizontally */
      flex-direction: row;
  }
  .legend-item {
      padding: 5px 0;
      margin-right: 15px; /* Add space between horizontal items */
  }
  .legend-item:last-child {
      margin-right: 0; /* Remove margin from the last item */
  }
  .legend-label {
      display: flex;
      align-items: center;
      font-weight: bold;
  }
  .legend-color-box {
      width: 15px;
      height: 15px;
      margin-right: 8px;
      border: 1px solid #555;
  }
  .legend-item sub {
    vertical-align: sub;
    font-size: smaller;
  }
</style>
</head>
<body>

<h1>Mobile Thermoelectric pRBC Refrigeration System</h1>
<p id="totalTimePassed">Total Run Time: --:--:--</p>
<p id="liveTempDisplay">Waiting for data...</p>

<div id="mainContentWrapper">
    <div id="chartContainer">
        <div id="graphdiv"></div>
    </div>
    <div id="legendContainer">
        <h3>Legend</h3>
        <div id="customLegend">Waiting for data...</div>
    </div>
</div>

<script>
  let dygraphChart;
  let dygraphData = [];
  const max_data_points = 10800;

  const totalTimePassedDisplay = document.getElementById('totalTimePassed');
  const liveTempDisplay = document.getElementById('liveTempDisplay');
  const customLegendDiv = document.getElementById('customLegend');
  
  const GOOGLE_SHEETS_SCRIPT_URL_JS = "https://script.google.com/macros/s/AKfycbzQR9pFbZ2_gMiWDAQHKI6l_ljM-56DwsU_ro9cECfPLk2uai6I-iL7LUoSwPIy3xzR/exec";
  const pollingInterval = 30000;

  let latestSecondsCounterValue = undefined;

  const formatNum = (num) => num < 10 ? '0' + num : num;

  function updateTotalTimePassedDisplay() {
    if (latestSecondsCounterValue === undefined) {
      totalTimePassedDisplay.textContent = 'Total Run Time: --:--:-- (Waiting for data...)';
      return;
    }
    const totalElapsedSeconds = latestSecondsCounterValue;
    const hours = Math.floor(totalElapsedSeconds / 3600);
    const minutes = Math.floor((totalElapsedSeconds % 3600) / 60);
    const seconds = Math.floor(totalElapsedSeconds % 60);
    totalTimePassedDisplay.textContent = `Total Run Time: ${formatNum(hours)}:${formatNum(minutes)}:${formatNum(seconds)}`;
  }
  setInterval(updateTotalTimePassedDisplay, 1000);

  function updateCustomLegend() {
    if (!dygraphChart) {
      customLegendDiv.innerHTML = 'Waiting for data...';
      return;
    }

    let html = '';
    const series = dygraphChart.getLabels().slice(1);
    const seriesColors = dygraphChart.getColors();

    series.forEach((label, i) => {
        const displayLabel = label.replace("T", "T<sub>") + "</sub>";
        html += `<div class="legend-item">
                    <span class="legend-label">
                        <div class="legend-color-box" style="background-color: ${seriesColors[i]};"></div>
                        <span>${displayLabel}</span>
                    </span>
                </div>`;
    });
    
    customLegendDiv.innerHTML = html;
  }

  async function fetchAllDataFromSheets() {
    try {
      const response = await fetch(`${GOOGLE_SHEETS_SCRIPT_URL_JS}?action=read_history`);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const allSensorData = await response.json();

      if (allSensorData.length > 0) {
        dygraphData = allSensorData.map(point => [
          new Date(point.timestamp * 1000),
          point.T_pRBC,
          point.T_enc,
          point.T_env,
          point.T_TEC
        ]);

        if (dygraphData.length > max_data_points) {
          dygraphData = dygraphData.slice(dygraphData.length - max_data_points);
        }

        const latestDataPoint = allSensorData[allSensorData.length - 1];
        latestSecondsCounterValue = parseInt(latestDataPoint.seconds_counter);

        liveTempDisplay.innerHTML = `Live Temperatures Plotting:
          T<sub>pRBC</sub> = ${latestDataPoint.T_pRBC !== undefined ? latestDataPoint.T_pRBC.toFixed(3) : '--.--'} &deg;C,
          T<sub>enc</sub> = ${latestDataPoint.T_enc !== undefined ? latestDataPoint.T_enc.toFixed(3) : '--.--'} &deg;C,
          T<sub>env</sub> = ${latestDataPoint.T_env !== undefined ? latestDataPoint.T_env.toFixed(3) : '--.--'} &deg;C,
          T<sub>TEC</sub> = ${latestDataPoint.T_TEC !== undefined ? latestDataPoint.T_TEC.toFixed(3) : '--.--'} &deg;C`;
      } else {
        liveTempDisplay.textContent = 'Waiting for data...';
        totalTimePassedDisplay.textContent = 'Total Run Time: --:--:-- (No data yet)';
        dygraphData = [];
        latestSecondsCounterValue = undefined;
      }

      const dygraphOptions = {
        labels: ["Time", "TpRBC", "Tenc", "Tenv", "TTEC"],
        ylabel: "Temperature (&deg;C)",
        xlabel: "Time-of-Day",
        axes: {
          y: { valueRange: [-6, 32] },
          x: { valueFormatter: Dygraph.dateString_ }
        },
        series: {
          "TpRBC": { color: "red" },
          "Tenc":  { color: "blue" },
          "Tenv":  { color: "green" },
          "TTEC":  { color: "orange" }
        },
        animatedZooms: false,
        drawPoints: true,
        strokeWidth: 1.5,
        legend: 'never',
        highlightCallback: null,
        unhighlightCallback: null
      };

      if (dygraphChart) {
        dygraphChart.updateOptions({ 'file': dygraphData });
      } else {
        dygraphChart = new Dygraph(document.getElementById("graphdiv"), dygraphData, dygraphOptions);
      }
      
      updateCustomLegend();

    } catch (error) {
      console.error("Error fetching all data from Sheets:", error);
      liveTempDisplay.innerHTML = `<span style="color:red;">Live Temperatures: Data Sync Error!</span>`;
      totalTimePassedDisplay.textContent = 'Total Run Time: Sync Error!';
      customLegendDiv.innerHTML = `<span style="color:red;">Sync Error!</span>`;
    }
  }

  fetchAllDataFromSheets();
  setInterval(fetchAllDataFromSheets, pollingInterval);
</script>
</body>
</html>
